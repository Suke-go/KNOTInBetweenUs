# 問題分析と根本原因

**対象ビルド**: 2024-Q4検証版  
**調査概要**: Exchangeシーン評価時に検出した致命的／重大な不具合を整理し、再発防止のための根本原因と一次対策を明確化する。

---

## 🔴 致命的な問題

### 問題1: Exchangeシーンでオーディオルーティングが切り替わらない
- **症状**: Exchangeシーン遷移後も左右チャンネルから自分自身の心拍しか聞こえず、交換演出が成立しない。
- **根本原因**  
  1. `ofApp` に `AudioRouter` メンバーが存在せず、`setup()` / `route()` を呼び出していない。  
  2. `AudioRouter::applyScenePreset()` がスタブ実装 (`void` 処理のみ) で、シーンごとのルールが反映されない。  
  3. `ofApp::audioOut()` が `AudioPipeline::audioOut()` を透過呼び出しするだけで、生成済みルーティング結果を合成していない。
- **影響**: Exchange/FirstPhase/Mixed で出力パターンが常に同一。作品の中核価値 (鼓動の交換体験) が失われる。
- **一次対策**: Phase1 Unit 1.1〜1.8 で AudioRouter を統合し、シーン遷移時にプリセット適用→バッファ生成を実装。

---

### 問題2: 片方のマイクだけがビジュアルと連動
- **症状**: 2系統のマイク入力を認識しているが、ビジュアルは片方の参加者の鼓動のみを反映。
- **根本原因**  
  1. `audioPipeline_.pollBeatEvents()` を引数なしで呼び、単一の統合ストリームしか参照していない。  
  2. 表示用エンベロープを `blendedEnvelope()` に固定し、参加者別メトリクス (`channelMetrics(ParticipantId)`) を取得していない。  
  3. `starfield` / `ripple` シェーダーが `uEnvelope` を1本だけ受け取り、2人分の可視化パラメータを受け入れない。
- **影響**: 2人参加シナリオで視覚的な相互作用が成立せず、片側参加に見える。Phase1 Unit 1.9〜1.12 が未着手。
- **一次対策**: 参加者別にメトリクスを取得 → GUI／シェーダーに2値を渡す経路を整備し、2ch独立描画へ移行。

---

### 問題4: ハプティクス信号生成が未実装
- **症状**: CH3/CH4 (触覚出力) に常時 0.0 が流れ、トランスデューサが駆動しない。
- **根本原因**  
  1. `settings.numOutputChannels` が 2 のまま固定され、サウンドストリームが 4ch モードで初期化されない。  
  2. `AudioRouter::generateHapticSample()` がスタブ (`return 0.0f;`) で、エンベロープ変調波を生成していない。  
  3. AudioRouter が `audioOut()` に統合されておらず、ハプティクス経路が存在しない (問題1の派生)。
- **影響**: 触覚フィードバックが完全に欠落。参加者へのフィジカルな没入感が大幅に低下。
- **一次対策**: Phase1 Unit 1.1, 1.4, 1.7 を完了し、50Hz サイン波を各参加者ごとに生成・出力。

---

## 🟡 重大な問題

### 問題3: ルーティングGUIが未実装
- **症状**: 実行時にルーティングを切り替える UI がなく、検証やデモ時の設定変更のたびに再ビルドが必要。
- **根本原因**  
  1. `drawGui()` に ImGui ベースのルーティングパネルが存在せず、AudioRouter のルール一覧を参照できない。  
  2. `AudioRouter` に公開 API (`rules()`, `setRule()`, `clearAllRules()` など) がなく、GUI 層から制御する手段が欠落。
- **影響**: デモ運用の柔軟性が低く、テストケースの切り替えや 1 人モード対応が困難。Phase2 の課題として残存。
- **一次対策**: Phase2 Unit 2.1〜2.4 で AudioRouter の API を拡張し、GUI からルール管理を可能にする。

---

## まとめ
- Exchange 体験、2ch 独立ビジュアル、ハプティクスの不備はすべて AudioRouter 未統合と単一ストリーム前提設計が共通原因。
- Phase1 で「ルーティング統合」「2ch 可視化」「ハプティクス生成」を最優先実装することで、致命的欠陥を同時解消できる。
- Phase2 は Phase1 完了後に着手し、GUI/API/シンセ心拍/プリセット保存を整備して運用柔軟性を確保する。
