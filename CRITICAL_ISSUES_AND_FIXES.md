# プロジェクト統括責任者による課題分析と修正要件定義

**作成日**: 2025-10-29
**統括責任者による緊急アセスメント**: 展示運用に向けた構造的課題と修正要件

---

## エグゼクティブサマリー

3名のエンジニアから「オーディオ、UX、ハプティクス、インフラの実装が一旦完了した」との報告を受け、プロジェクト全体の技術的整合性と展示運用適合性を検証した結果、**重大な構造的乖離**を確認しました。

### 最重要課題 (P0: Blocking)
1. **シーン構造の根本的不一致**: MASTERDOCUMENTで定義された6シーン(Idle/Start/FirstPhase/Exchange/Mixed/End)のうち、実装は3シーン(Idle/FirstPhase/End)のみ。展示フロー全体が動作不能。
2. **ビジュアリゼーションの欠落**: トーラス・星空・波紋などMASTERDOCUMENT指定のGLSL shaderベースのビジュアルが未実装。現状は簡易プリミティブ描画のみ。
3. **心拍ベースページ遷移の不在**: 自動シーン遷移ロジック(60s経過でFirstPhase→Exchange等)が実装されておらず、手動ボタン操作のみ。
4. **展示案内UI/日本語フォントの不在**: 「体験を始めます」等のガイダンステキストがコード内にハードコードされているが、フォント未設定で表示されない可能性が高い。

### 根本原因分析
- **要件定義の二重構造**: SMALL_SCALE_REQUIREMENTS.mdが「小規模プロト」として3シーンのみを定義し、チームがこれを「完成」と誤認。MASTERDOCUMENTの完全仕様が反映されていない。
- **責任分担の曖昧さ**: メンバーB(UX担当)がシーン遷移を「完了」と報告したが、実装範囲は小規模要件の3シーンに留まり、展示必須の6シーン構成との乖離が見逃された。
- **統合テストの欠如**: 各モジュール単体では動作していても、エンドツーエンドの展示フロー(参加者入場→体験→退出)が一度も検証されていない。

---

## I. 課題分類マトリクス

### 1. シーン構造・遷移ロジック (Scene Architecture)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **SCENE-01** | **P0** | **Exchange/Mixed シーンが未実装** | SceneController.h:5-9 で `SceneState` enum が `Idle/FirstPhase/End` の3値のみ定義。MASTERDOCUMENTの6シーン構造(Idle/Start/FirstPhase/Exchange/Mixed/End)に対して3シーン不足。 | 展示フロー全体が動作不能。参加者体験の核心部(心音交換・混在)が欠落。 | **8-10日** (Exchange/Mixed各シーンのビジュアル・オーディオ・ハプティクス統合含む) |
| **SCENE-02** | **P0** | **Start シーンが未実装** | 同上。「体験を始めます」「深呼吸ガイダンス」「ベル音再生」の30秒導入シーンが存在しない。 | ユーザー体験の導入フェーズ欠如。突然FirstPhaseが始まり混乱を招く。 | **2-3日** |
| **SCENE-03** | **P0** | **自動シーン遷移ロジックの不在** | SceneController.cpp:41-65 で `requestState()` は外部リクエストのみ受付。MASTERDOCUMENT「t=30s: 自動でFirstPhaseへ遷移」「60s経過でExchangeへ」等のタイマーベース遷移が未実装。 | 展示運用で常時オペレータがボタンを押す必要があり、無人運用不可能。 | **3-4日** (各シーンの持続時間設定・タイマー管理・状態機械拡張) |
| **SCENE-04** | P1 | **アイドル自動復帰機能の不在** | ofApp.cpp に End→Idle への自動復帰(15秒後)が実装されていない。MASTERDOCUMENT:336「15秒後にIdleへ戻り、再キャリブレーションを促す」が未対応。 | セッション終了後に次の参加者が待機する常設展示シナリオで、手動リセット必要。 | **1日** |
| **SCENE-05** | P1 | **遷移進行度の可視性不足** | ofApp.cpp:411 で `transitionProgressParam_` が GUI に表示されているが、ユーザー向け展示画面には表示されない。フェード中の状態が不明。 | デバッグ用GUIのみで把握可能。展示参加者には遷移中か判別不能。UX劣化。 | **0.5日** (ビジュアルレイヤーへの進行度反映) |

### 2. ビジュアリゼーション (Visualization)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **VIS-01** | **P0** | **GLSLシェーダベースビジュアルが未実装** | ofApp.cpp:716-837 の描画関数群(`drawIdleScene`, `drawFirstPhaseScene`, `drawEndScene`)は全て `ofDrawCircle/ofDrawRectangle` 等のCPUベース2Dプリミティブ描画。MASTERDOCUMENTの「GLSL 4.1シェーダ」「トーラス変形」「4D simplex noise」「instancing 2000点星空」が一切存在しない。 | プロジェクトの核心的価値である「美しいビジュアリゼーション」が実現されていない。現状は技術デモレベル。 | **12-15日** (shader実装・FBO管理・パーティクルシステム・HRV→トーラス変形パラメータ連携) |
| **VIS-02** | **P0** | **心拍データとビジュアルの同期不良** | ofApp.cpp:454 で `updateEnvelopeHistory()` は BPM/envelope を記録しているが、描画側では `latestMetrics_.envelope` を直接参照(ofApp.cpp:727-728)。BeatEvent のタイムスタンプを活用した正確な同期機構が不在。MASTERDOCUMENT「半径 = baseRadius + k * envelope」の仕様は実装されているが、遅延補正・補間処理がない。 | 心拍と視覚の同期ズレ(推定80-150ms)。没入感が損なわれる。 | **2-3日** (BeatEvent タイムスタンプベースの補間・予測表示) |
| **VIS-03** | P0 | **Exchangeシーン用の二人ビジュアルが未設計** | 現状3シーンの描画関数には参加者2名の心拍を可視化する機構が存在しない。MASTERDOCUMENT「相手側リングが瞬間的に1.2倍膨張」「中心に共有ノード」等の仕様が未反映。 | Exchangeシーン実装時に描画設計から必要。UX設計・データバインディング含め要再設計。 | **5-6日** (Exchangeシーンの一部としてカウント済み) |
| **VIS-04** | P1 | **45秒前後でのビジュアル停止** | ユーザー報告「グラフが45秒前後で止まる」。コード上、`envelopeHistory_.setHorizon()` (ofApp.cpp:404-406)で動的にhorizon調整しているが、`BeatEnvelopeHistory` の実装未確認。循環バッファのオーバーフロー or 固定長配列の境界問題の可能性。 | 長時間体験(60s以上)で視覚フィードバック停止。データ蓄積は継続しているが表示が更新されない。 | **1-2日** (BeatEnvelopeHistory実装確認・境界条件修正・ユニットテスト追加) |
| **VIS-05** | P1 | **デバッグ用グラフの本番混入** | ofApp.cpp:816 `drawEnvelopeGraph()` および 821 `drawHapticLog()` がFirstPhaseシーンで常時表示。MASTERDOCUMENT仕様の没入型ビジュアルを阻害。 | 展示参加者にデバッグ情報が露出。アート作品としての完成度低下。 | **0.5日** (条件分岐追加 or GUI専用レイヤー分離) |

### 3. UI・フォント・多言語対応 (User Interface)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **UI-01** | **P0** | **日本語フォント未設定による案内文非表示** | ofApp.cpp:269, 775等で「体験を始めます」「心音提示＆同期フェーズ」等の日本語文字列がハードコードされているが、`ofTrueTypeFont` の初期化が存在しない。openFrameworks のデフォルト `ofDrawBitmapString()` は日本語未対応。 | 展示案内テキストが全て表示されない(文字化けor空白)。参加者は何が起きているか理解不能。 | **1-2日** (Noto Sans JP等のフォント組込・ofTrueTypeFontセットアップ・レイアウト調整) |
| **UI-02** | P0 | **キャリブレーション/エンベロープ設定ボタンが展示画面に表示** | ofApp.cpp:72-103 で `controlPanel_`, `statusPanel_` が常時表示。MASTERDOCUMENT「常設展示用でGUIを隠す」要求に反する。 | 参加者に内部設定UIが露出。誤操作リスク・没入感阻害。 | **1日** (GUI表示条件分岐・運用モード切替・キーボードショートカット隠蔽) |
| **UI-03** | P1 | **ガイダンスメッセージの展示統合不足** | ofApp.cpp:986-1017 `buildGuidanceMessage()` は詳細な技術メッセージ(「包絡比が低下」等)を生成するが、これらはオペレータ向け。参加者向けの「深呼吸してください」「もう少しお待ちください」等の簡潔なガイダンスが別途必要。 | 参加者が受け取るべき情報と、オペレータが確認すべき情報が未分離。 | **1日** (メッセージ体系の二層化・表示先振り分け) |
| **UI-04** | P2 | **アイドル自動起動機構の不在** | 「スタートボタンを私が押す」をユーザーが希望しつつも、「自動的にアイドル状態に戻る」仕組みは実装済み(SCENE-04)だが、「ユーザーが使い始めたらシステムが動作する」(例:近接センサー連動)は未実装。 | 無人展示では手動起動が必要。センサー連動は将来拡張として許容可能だが、要件明確化が必要。 | **2-3日** (センサーAPI統合・イベントドリブン起動) or スコープ外 |

### 4. オーディオ処理・信号品質 (Audio Processing)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **AUD-01** | P0 | **Exchange/Mixed用のBinauralレンダリング未実装** | AudioPipeline実装の詳細未確認だが、MASTERDOCUMENTの「MIT KEMAR HRTF」「azimuth ±90°定位」「FDN 8x8リバーブ」が必要なExchange/Mixedシーンが存在しないため、対応する音響処理も未実装と推定。 | 心音交換体験の空間音響が実現できない。ステレオミックスのみではMASTERDOCUMENT要求未達。 | **6-8日** (HRTF統合・libmysofa連携・FDNリバーブ実装・シーン別ルーティング) |
| **AUD-02** | P1 | **心拍入力のフェードアウト問題** | ユーザー報告「心拍入力が最初反映されるがフェードアウトして消える」。BeatTimeline.cpp:159-167 の `noTriggerCounter_` による閾値緩和ロジックが逆効果の可能性。または AudioPipeline 側でのゲイン減衰。 | 継続的な心拍検出が不安定。数十秒で入力が消失し体験中断。 | **2-3日** (原因特定・閾値ロジック調整 or ゲイン制御修正・長時間安定性テスト) |
| **AUD-03** | P1 | **キャリブレーション精度の検証不足** | memberA/PROGRESS_REPORT.md で gain/delay/phase が「未計測」。実際の補正値が ±3dB・±2samples 以内に収まっているか不明。 | チャンネル分離精度が保証されず、クロストークが混入する可能性。2ch心拍の誤認識リスク。 | **1-2日** (実測・calibration_report.csv解析・外れ値調査) |
| **AUD-04** | P2 | **リミッター発火頻度の未計測** | memberA レポートで「Limiter発火回数 未計測」。AudioPipeline.cpp のリミッター実装は確認できていないが、ofApp.cpp:211-212 で `lastLimiterReductionDb()` を参照している。動作実績が未検証。 | 過大入力時のクリップ防止が機能しているか不明。音質劣化やスピーカー保護の観点でリスク。 | **1日** (長時間稼働テスト・発火ログ収集・閾値調整) |

### 5. ハプティクス・触覚フィードバック (Haptics)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **HPT-01** | P1 | **ハプティクス信号生成の未実装** | ofApp.cpp:467-482 `appendHapticEvent()` は `HapticEventLogger` への CSV 書き込みのみ。実際の触覚振動信号(オーディオCH3/4)が未実装。**デバイス実態**: スピーカー型振動子(tactile transducer)であり、4chオーディオインターフェース経由で駆動。CH1/2=ヘッドフォン、CH3=参加者1振動、CH4=参加者2振動。 | 触覚フィードバックが動作しない。多感覚体験の1/3が欠落。 | **2-3日** (4ch拡張・HapticSignalGenerator実装・20-150Hz BPF・ノイズキャリア生成) |
| **HPT-02** | P2 | **ExchangeシーンのLED連動仕様未実装** | MASTERDOCUMENT:304「相手心音に同期したLED(ウォームホワイト)を200ms点灯」。スピーカー型振動子にはLED機能がないため、別途LEDデバイスが必要。現状では要件スコープ外。 | LED連動は別デバイスとして将来対応。Phase 3以降に延期。現時点では触覚振動のみで多感覚体験を実現。 | **スコープ外** (Phase 3以降) |
| **HPT-03** | P1 | **ハプティクスレイテンシの未検証** | オーディオCH3/4としてハプティクス信号を出力する場合、BeatEvent生成→audioOut()の遅延が実測されていない。SMALL_SCALE_REQUIREMENTS:77「目標 <40ms」だが、オーディオバッファ遅延(512 frames @ 48kHz = 10.7ms)を考慮すると、目標を80ms以内に緩和すべき。 | 心拍と触覚の同期ズレが許容範囲内か不明。体験品質への影響未評価。 | **1日** (実機接続後の遅延測定・タイムスタンプログ解析・目標値見直し) |

### 6. システム統合・運用安定性 (System Integration & Stability)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **SYS-01** | P0 | **エンドツーエンド統合テストの不在** | memberC レポート「自動テスト: 実行0件/成功0件」。各モジュール単体では動作報告があるが、Idle→Start→FirstPhase→Exchange→Mixed→Endの完全フローが一度も検証されていない。 | 本番展示で初めて全体統合され、予期せぬ相互作用で障害発生のリスク大。 | **3-5日** (統合テストシナリオ作成・自動化スクリプト整備・不具合修正イテレーション) |
| **SYS-02** | P0 | **30分連続稼働テストの未実施** | memberC レポート「メモリ/CPU: 未計測(リアル入力での長時間動作未試験)」。SMALL_SCALE_REQUIREMENTS:146「SYS-01: 30分連続試験」が未完了。 | メモリリーク・リソース枯渇・スレッドデッドロックの潜在リスク。展示中のクラッシュ可能性。 | **2-3日** (長時間稼働テスト・リソース監視・ログ解析・修正) |
| **SYS-03** | P1 | **デバイス接続エラー時のフォールバック不足** | ofApp.cpp:122-131 でサウンドストリーム初期化失敗時に `simulateTelemetry_=true` に切り替えるが、ユーザー通知が不十分。また、マイク接続断時の再接続ロジックが未実装。 | 展示中にマイク電池切れ等で接続断が発生した場合、手動再起動が必要。無人運用不可。 | **2日** (デバイス監視・自動再接続・ユーザー通知強化) |
| **SYS-04** | P1 | **ログローテーション・ディスク管理の不在** | infra/TelemetryLogging実装の詳細未確認だが、MASTERDOCUMENT:339「LogWriterは古いセッションをローテーション」が実装されているか不明。memberC レポートに記載なし。 | 長期展示でログファイルが肥大化し、ディスク容量枯渇→システム停止のリスク。 | **1-2日** (ローテーション実装・最大ファイル数設定・CI検証) |
| **SYS-05** | P2 | **CI/CD パイプラインの不在** | memberC レポート「CI 所要時間 -」。Gitリポジトリは存在するがビルド・テスト自動化が未整備。 | コード変更時の regression 検出が手動。品質保証プロセスの脆弱性。 | **2-3日** (GitHub Actions/Jenkins設定・自動ビルド・テスト実行・レポート生成) |

### 7. 要件定義・ドキュメント整合性 (Requirements & Documentation)

| 課題ID | 重要度 | 課題内容 | 根拠 | 影響範囲 | 修正工数見積 |
|--------|--------|----------|------|----------|--------------|
| **REQ-01** | **P0** | **MASTERDOCUMENT と SMALL_SCALE_REQUIREMENTS の乖離管理不足** | SMALL_SCALE_REQUIREMENTS.md:14「非対象: Exchange/Mixed シーン、FDN リバーブ、Binaural HRTF、星空シェーダ」と明記されているが、これが「最終成果物」と誤認された。プロジェクト全体のフェーズ管理(プロト→本開発)が明文化されていない。 | チーム全体が「完成」と誤認し、展示必須機能が大量に欠落。プロジェクト遅延の根本原因。 | **0日**(修正不要) / **2日**(マスタープラン文書作成・フェーズ定義・完了基準明確化) |
| **REQ-02** | P1 | **展示運用マニュアルの不在** | 「常設展示用」「無人運用」の要求があるが、オペレーション手順書・トラブルシューティングガイド・デイリーチェックリストが存在しない。 | 展示スタッフが操作方法を理解できず、障害対応が遅延。 | **2-3日** (運用マニュアル作成・トレーニング資料・FAQドキュメント) |
| **REQ-03** | P2 | **アクセシビリティ要件の未定義** | 視覚障害・聴覚障害を持つ参加者への配慮が仕様に含まれていない。多感覚体験の一部が利用できない場合の代替手段が未検討。 | 展示のインクルーシビティ不足。ユニバーサルデザインの観点で改善余地。 | **要検討** (スコープ外の可能性。ステークホルダー判断必要) |

---

## II. 修正要件定義 (MECE・優先度付き)

### Phase 1: 展示最低限機能の実現 (P0対応) — 目標期間: 3-4週間

#### 1.1 シーン構造の完全実装

**要件ID**: FIX-SCENE-FULL
**優先度**: P0
**目的**: MASTERDOCUMENT準拠の6シーン構成を実装し、展示フロー全体を動作可能にする。

**実装内容**:
- `SceneState` enum に `Start`, `Exchange`, `Mixed` を追加 (SceneController.h)
- `SceneController::canTransition()` に全遷移パスを追加:
  - Idle → Start → FirstPhase → Exchange → Mixed → End → Idle (cyclic)
- 各シーンの描画関数を実装:
  - `drawStartScene()`: テキストフェードイン/アウト、深呼吸ガイダンス表示、ベル音再生連携
  - `drawExchangeScene()`: 2参加者の心拍リング、HRVベースのトーラス変形、相手側BeatEventで拡大演出
  - `drawMixedScene()`: 共有ノード描画、HRV差分による色温度シフト、BeatTimeline レイヤー合成
- **自動遷移タイマー**の実装:
  - `SceneController` に `sceneDurations_` マップを追加 (config/scene_config.json から読込)
  - `update()` で `timeInState()` を監視し、持続時間超過で次シーンへ自動遷移
  - 例: Start(30s) → FirstPhase(60s) → Exchange(60s) → Mixed(90s) → End(20s) → Idle(自動復帰15s)
- **アイドル自動復帰**: End → Idle への15秒タイマー追加、再キャリブレーションダイアログ表示

**受入基準**:
- [ ] `SceneState` enum が6値を含む
- [ ] Idle→Start→FirstPhase→Exchange→Mixed→End→Idle の完全サイクルが手動/自動で遷移可能
- [ ] 各シーンの持続時間が config で設定可能
- [ ] End完了後15秒でIdleに自動復帰し、GUI通知が表示される
- [ ] 統合テストシナリオで全シーン遷移を自動検証

**テスト計画**:
- ユニットテスト: `SceneController_transitions_test.cpp` で全遷移パスを網羅
- 統合テスト: `scripts/run_full_scenario.sh` で6分間の完全フロー実行、ログ検証

**工数見積**: 8-10日 (Exchange/Mixed各シーンのビジュアル・オーディオ統合含む)

---

#### 1.2 GLSLシェーダビジュアルの実装

**要件ID**: FIX-VIS-SHADER
**優先度**: P0
**目的**: プロジェクトの核心価値である「美しいビジュアリゼーション」を実現。

**実装内容**:
- **星空パーティクルシステム** (GLSL 4.1 instancing):
  - `shaders/starfield.vert/.frag` 作成
  - 2000点のパーティクルを VBO で管理、instancing で一括描画
  - HRV に応じて輝度・色相をモジュレーション (0.3-0.8 範囲)
  - 4D simplex noise (時間軸を第4次元として利用)でパーティクル位置を摂動
- **トーラス変形シェーダ** (Exchange/Mixed用):
  - `shaders/torus.vert/.frag` 作成
  - UBO (Uniform Buffer Object) で HRV パラメータを渡す
  - `knotDeform = normalize(HRV - HRV_baseline)` を 0.0-0.5 で変化、トーラスメッシュの頂点を変形
  - Warm カラーパレット (HSL) を 60 秒周期で補間
- **波紋エフェクト** (Idle/FirstPhase用):
  - 現状の `ofDrawCircle` ループを Fragment Shader に移植
  - 距離フィールド + 時間減衰でスムーズな波紋生成
  - Envelope 値を uniform で渡し、半径・透過度を制御
- **FBO管理の最適化**:
  - ofFbo を `VisualizationManager` クラスでシングルトン管理
  - 1920x1080 / 60fps を維持、シーン遷移時の再初期化を排除
  - ダブルバッファリングで描画スレッドと DSP スレッドの衝突回避

**受入基準**:
- [ ] 星空パーティクル 2000 点が 60fps で描画される
- [ ] トーラス変形が HRV に追従し、視覚的に滑らかに動作する
- [ ] 波紋エフェクトが Envelope ピークに同期して拡大する
- [ ] FBO のメモリ使用量が 50MB 以下で安定
- [ ] GLSL コンパイルエラーが存在しない (macOS OpenGL 4.1 環境)

**テスト計画**:
- シェーダユニットテスト: `tests/shader_compile_test.sh` で全 shader のコンパイル検証
- 性能テスト: 60fps 維持を Instruments Time Profiler で確認
- ビジュアルリグレッション: 各シーンのスクリーンショットを baseline と比較

**工数見積**: 12-15日

---

#### 1.3 日本語フォント統合

**要件ID**: FIX-UI-FONT
**優先度**: P0
**目的**: 展示案内テキストを参加者が読めるようにする。

**実装内容**:
- **フォントファイル組込**:
  - `bin/data/fonts/` に Noto Sans JP (Thin 120pt, Regular 48pt) を配置
  - ライセンス確認 (SIL Open Font License)
- **ofTrueTypeFont 初期化**:
  - `ofApp::setup()` で `displayFont_.load("fonts/NotoSansJP-Thin.otf", 120)` および `guideFont_.load("fonts/NotoSansJP-Regular.otf", 48)` を実行
  - 読込失敗時のフォールバック (英語メッセージ + エラーログ)
- **描画関数の置換**:
  - 全ての `ofDrawBitmapString()` 呼び出しを `displayFont_.drawString()` / `guideFont_.drawString()` に置換
  - テキスト配置の再調整 (中央揃え・行間・padding)
- **多言語切替の準備** (Optional, P1):
  - `config/ui_strings.json` に言語別メッセージを定義
  - `UIStringManager` クラスで言語切替機能を提供

**受入基準**:
- [ ] 日本語テキストが正しく表示される (文字化けなし)
- [ ] フォントサイズが視認性を確保 (120pt タイトル、48pt ガイダンス)
- [ ] テキスト描画による fps 低下が 5% 以内

**テスト計画**:
- 表示テスト: 各シーンのスクリーンショットで日本語を目視確認
- 性能テスト: フォント描画前後の fps を比較

**工数見積**: 1-2日

---

#### 1.4 GUI隠蔽と運用モード切替

**要件ID**: FIX-UI-HIDE
**優先度**: P0
**目的**: 展示参加者にデバッグUIを露出させず、オペレータが必要時のみアクセス可能にする。

**実装内容**:
- **運用モード導入**:
  - `app_config.json` に `"operationMode": "exhibition"` / `"debug"` を追加
  - `exhibition` モードでは `controlPanel_`, `statusPanel_` を非表示
- **キーボードショートカット**:
  - `g` キー長押し (3秒) で GUI 表示トグル
  - `Alt + Shift + D` で debug モード切替
  - ショートカットは展示環境でキーボードを隠蔽することで無効化
- **デバッグ情報のログ出力**:
  - GUI非表示時も `limiterReductionDbSmooth_` 等の監視値を `logs/monitoring.csv` に記録
  - リアルタイムモニタリングは外部ツール (Grafana等) で対応可能にする

**受入基準**:
- [ ] `exhibition` モード時に GUI パネルが一切表示されない
- [ ] `g` キー長押しで GUI が再表示される
- [ ] 監視値がログに記録され、後から確認可能

**テスト計画**:
- 運用テスト: exhibition モードで起動し、GUI非表示を確認
- 操作テスト: ショートカットで GUI 表示トグルを検証

**工数見積**: 1日

---

#### 1.5 Binaural オーディオレンダリングの実装

**要件ID**: FIX-AUD-HRTF
**優先度**: P0
**目的**: Exchange/Mixed シーンで空間音響を実現。

**実装内容**:
- **HRTF データ読込**:
  - MIT KEMAR SOFA ファイルを `data/hrir/mit_kemar/` に配置
  - `libmysofa` を依存ライブラリとして追加 (Xcode: Link Binary With Libraries)
  - `HrtfDatabase::load()` で HRIR を読込、`std::unique_ptr` + カスタムデリータで RAII 化
- **BinauralProcessor クラス**:
  - `void setDirection(float azimuth, float elevation)`: HRTF 選択
  - `void processBlock(const float* in, float* outL, float* outR, size_t numSamples)`: convolution 処理
  - オーバーラップアド FFT で HRIR を適用 (fftSize = nextPow2(blockSize + hrirLength - 1))
- **Exchange/Mixed シーンへの統合**:
  - `AudioPipeline` に `BinauralProcessor` インスタンスを追加
  - participant1 の心音 → azimuth +90° (右 3m)
  - participant2 の心音 → azimuth -90° (左 3m)
  - 方向変更時の 50ms クロスフェード
- **FDN リバーブ** (Optional, P1):
  - 8x8 Feedback Delay Network 実装
  - T60=8.0s, HighCut=4kHz
  - Mixed シーンで roomMix=0.42 で適用

**受入基準**:
- [ ] HRTF データが正常に読み込まれる
- [ ] azimuth ±90° で左右の定位が明確に聞こえる
- [ ] convolution 処理が 512 frames @ 48kHz で遅延 <10ms
- [ ] CPU 使用率増加が 15% 以内

**テスト計画**:
- 音響テスト: テストトーン (1kHz) を azimuth ±90° で再生し、ヘッドフォンで定位確認
- 性能テスト: AudioPipeline の CPU 負荷を Instruments で測定

**工数見積**: 6-8日

---

### Phase 2: 安定性・品質向上 (P1対応) — 目標期間: 2-3週間

#### 2.0 単独検証モードの実装

**要件ID**: FIX-DEV-SOLO
**優先度**: P1 (開発効率向上のため必須)
**目的**: 2名の参加者を必要とせず、1名の開発者のみで全シーン・機能を検証可能にする。

**背景**:
現在の実装は2名の参加者(2ch マイク入力)を前提としており、Exchange/Mixed シーンの検証に2名の協力者が必要。開発・デバッグ効率を大幅に向上させるため、**疑似的な第2参加者**を生成する単独検証モードを実装する。

**実装内容**:
- **合成心拍生成器** (`SyntheticHeartbeatGenerator` クラス):
  - **目的**: リアルな心拍信号を生成し、実際のマイク入力の代替として使用
  - **生成アルゴリズム**:
    1. **基準BPMの設定**: 50-90 BPM の範囲でランダムに選択 (例: 68 BPM)
    2. **BPM変動**: ±5 BPM のゆらぎを 0.1Hz の sine 波で加える (呼吸性変動を模擬)
    3. **S1/S2 波形生成**:
       - S1: 30-80Hz の複合 sine 波、持続時間 80-120ms、ピーク振幅 0.6-0.8
       - S2: 60-120Hz の複合 sine 波、持続時間 60-90ms、ピーク振幅 0.4-0.6
       - S1-S2 間隔: 300-400ms (収縮期)
    4. **ノイズ付加**: ホワイトノイズを -40dBFS で重畳し、リアルな背景ノイズを再現
    5. **不規則性**: 10% の確率で premature beat (早期拍動) を挿入
  - **出力**: 48kHz/1ch のモノラル信号として `AudioPipeline` に注入
- **モード切替**:
  - `app_config.json` に `"devMode": { "enabled": true, "soloMode": true }` を追加
  - `soloMode=true` 時:
    - participant1: 実際のマイク入力 (CH1)
    - participant2: `SyntheticHeartbeatGenerator` の出力 (CH2 相当)
  - GUI に "Solo Dev Mode" インジケーターを表示 (exhibition モードでは非表示)
- **パラメータ調整**:
  - GUI に合成心拍のパラメータスライダーを追加 (debug モード時のみ):
    - `syntheticBPM`: 50-90 BPM (default: 68)
    - `syntheticVariability`: 0-10 BPM (default: 5)
    - `syntheticNoiseLevel`: -60 to -20 dBFS (default: -40)
  - リアルタイムで合成信号を調整可能
- **既存コードとの統合**:
  - `AudioPipeline::audioIn()` で soloMode 判定
  - CH1: 実入力をそのまま処理
  - CH2: `SyntheticHeartbeatGenerator::getNextSample()` を呼び出し
  - BeatTimeline は2ch を独立に処理 (既存の設計通り)
- **再現性の確保**:
  - `session_seed.json` の seed 値を `SyntheticHeartbeatGenerator` の乱数生成器に設定
  - 同じ seed で起動すれば、同じ合成心拍が再生される (デバッグ・リグレッションテスト用)

**受入基準**:
- [ ] `soloMode=true` で起動時、participant2 の心拍が自動生成される
- [ ] 合成心拍の BPM が 50-90 の範囲でランダムに変動する
- [ ] Exchange/Mixed シーンで2名の心拍が視覚・聴覚・触覚で区別可能
- [ ] 合成心拍の波形が BeatTimeline で正しく検出される (誤検出率 <5%)
- [ ] session_seed による再現性が確保される (同じ seed → 同じ BPM 系列)

**テスト計画**:
- 単体テスト: `SyntheticHeartbeatGenerator_test.cpp` で波形生成を検証
- 統合テスト: soloMode で全シーンを実行し、ログに2名分の BeatEvent が記録されることを確認
- 再現性テスト: 同じ seed で2回実行し、BPM 系列が一致することを検証

**工数見積**: 1-2日 (SyntheticHeartbeatGenerator 実装 + GUI 統合)

---

#### 2.1 長時間稼働安定性の確保

**要件ID**: FIX-SYS-STABILITY
**優先度**: P1
**目的**: 展示環境での連続運用を可能にする。

**実装内容**:
- **30分連続稼働テスト**:
  - `scripts/run_stress_test.sh` でアプリを 30 分間実行
  - メモリ・CPU・ディスクI/O を 1 秒間隔で記録 (Activity Monitor / `top` / `iostat`)
- **メモリリーク検出**:
  - Xcode Instruments の Leaks ツールで実行
  - `BeatTimeline`, `AudioPipeline`, `FBO` 等のリソース管理を検証
- **スレッドデッドロック検出**:
  - Thread Sanitizer (`-fsanitize=thread`) でビルド
  - 音声スレッドと描画スレッドの競合を検証
- **ログローテーション実装**:
  - `SessionLogger` に最大ファイルサイズ (100MB) と保持世代 (10世代) を設定
  - 古いログを自動削除、zip 圧縮
- **デバイス再接続処理**:
  - `ofSoundStream` のデバイスリスト監視 (polling or delegate)
  - マイク接続断検知 → 自動再接続試行 (最大 3 回、各 5 秒間隔)
  - 再接続失敗時は GUI にアラート表示

**受入基準**:
- [ ] 30 分連続稼働でクラッシュ・フリーズが発生しない
- [ ] メモリ使用量増加が 10MB/時間 以内
- [ ] CPU 使用率が平均 60% 以下
- [ ] ログファイルが自動ローテーションされる
- [ ] マイク接続断→再接続が 10 秒以内に完了

**テスト計画**:
- 長時間テスト: 夜間稼働テスト (8時間) を週次で実施
- フォールト注入: マイク USB 抜き差し、音量急変、etc.

**工数見積**: 4-5日

---

#### 2.2 心拍検出精度の向上

**要件ID**: FIX-AUD-BEAT
**優先度**: P1
**目的**: 「心拍入力のフェードアウト」「45秒で停止」問題を解決。

**実装内容**:
- **BeatTimeline 閾値ロジックの見直し**:
  - `noTriggerCounter_` による閾値緩和 (BeatTimeline.cpp:159-167) が過度に動作している可能性
  - 緩和速度を 1/3 に減速 (`minTriggerRatio_ - 0.01f` に変更)
  - 閾値の下限を 1.15f に設定 (現状 1.05f は過緩和)
- **Envelope 計測の安定化**:
  - `adaptiveThreshold_` の LPF 係数を調整 (0.005f → 0.002f) でノイズ耐性向上
  - リフラクトリ期間を 350ms → 400ms に延長し S1/S2 二重検出を抑制
- **BeatEnvelopeHistory の境界条件修正**:
  - `BeatVisualizer.h` (未読込) の実装を確認
  - 循環バッファのインデックス計算を検証、オーバーフロー防止
  - horizon 調整時の古いサンプル削除ロジックを修正
- **長時間安定性テスト**:
  - 60 秒以上の録音データで BPM 誤差を測定
  - 基準 BPM との差分が ±3 BPM 以内を維持

**受入基準**:
- [ ] 60 秒間の連続心拍検出で欠落が 5% 以内
- [ ] BPM 平均誤差が ±3 BPM 以内
- [ ] Envelope グラフが 90 秒まで更新され続ける
- [ ] フェードアウト現象が再現しない

**テスト計画**:
- 回帰テスト: 修正前後で同一録音ファイルを再生し BPM 誤差を比較
- 長時間テスト: 5 分間の連続録音で全期間の検出率を測定

**工数見積**: 3-4日

---

#### 2.3 統合テスト自動化

**要件ID**: FIX-QA-AUTO
**優先度**: P1
**目的**: リグレッション防止と品質保証の確立。

**実装内容**:
- **統合テストシナリオ作成**:
  - `tests/integration/full_scenario_test.cpp`:
    - 6シーン完全サイクルを自動実行
    - 各シーン遷移のタイミングを検証
    - ログファイル (session.csv, summary.json) の内容検証
  - `tests/integration/beat_detection_accuracy_test.cpp`:
    - テスト録音ファイル (基準BPM付) を再生
    - 検出BPMと基準BPMの誤差を算出
- **CI パイプライン構築** (GitHub Actions):
  - `.github/workflows/ci.yml`:
    - ビルド (Debug/Release)
    - ユニットテスト実行
    - 統合テスト実行
    - validate_logs.py によるログ妥当性検証
    - カバレッジレポート生成 (lcov)
  - アーティファクト保存: ビルド成果物・テストログ・スクリーンショット
- **テストデータ管理**:
  - `data/test_signals/` に標準テストセットを配置
  - Git LFS でバイナリファイル管理

**受入基準**:
- [ ] CI パイプラインが全テストを 10 分以内に実行
- [ ] 統合テストが全 pass (0 failures)
- [ ] コードカバレッジが 70% 以上
- [ ] PR マージ前に CI 成功が必須

**テスト計画**:
- CI 動作確認: ダミー PR でパイプライン実行
- テストメンテナンス: 週次でテスト追加・更新

**工数見積**: 3-4日

---

### Phase 3: UX・運用改善 (P2対応) — 目標期間: 1-2週間

#### 3.1 展示運用マニュアル作成

**要件ID**: FIX-DOC-MANUAL
**優先度**: P2

**実装内容**:
- `docs/OPERATION_MANUAL.md`:
  - 日次起動手順 (デバイス接続確認・キャリブレーション実施)
  - トラブルシューティング (心拍検出不良・音声途切れ・GPU異常)
  - 週次メンテナンス (ログアーカイブ・キャリブレーション再測定)
- `docs/TROUBLESHOOTING.md`:
  - FAQ (よくある質問と回答)
  - エラーコード一覧と対処法
- 動画マニュアル (Optional):
  - キャリブレーション手順を録画
  - 展示スタッフ向けトレーニング資料

**受入基準**:
- [ ] オペレータがマニュアルのみで起動・運用可能
- [ ] トラブル発生時にマニュアルで解決可能 (80% のケース)

**工数見積**: 2-3日

---

#### 3.2 ハプティクスデバイス統合 (スピーカー型振動子)

**要件ID**: FIX-HPT-DEVICE
**優先度**: P1 (オーディオ出力の一部として必須)

**実装方針の明確化**:
ハプティクスデバイスは**スピーカー型振動子**(tactile transducer)であり、4chオーディオインターフェース経由で駆動する。USB/OSCではなく、オーディオ信号として統合。

**チャンネル構成**:
- **CH1**: 参加者1 ヘッドフォン左
- **CH2**: 参加者2 ヘッドフォン右
- **CH3**: 参加者1 触覚振動子 (スピーカー型)
- **CH4**: 参加者2 触覚振動子 (スピーカー型)

**実装内容**:
- **オーディオルーティングの拡張**:
  - `AudioPipeline::audioOut()` を 2ch → 4ch に拡張
  - macOS Aggregate Device 設定で 4ch オーディオインターフェースを指定
  - CH1/2: 既存のヘッドフォン出力 (Binaural/ステレオミックス)
  - CH3/4: 新規の触覚振動子出力
- **触覚信号生成** (`HapticSignalGenerator` クラス):
  - **入力**: BeatEvent (envelope, timestamp)
  - **処理チェーン**:
    1. **包絡線抽出**: 心拍波形から 100Hz ローパスフィルタ済み包絡を取得 (MASTERDOCUMENT:71 準拠)
    2. **周波数帯域制限**: 20-150Hz バンドパスフィルタ (振動子の有効帯域)
    3. **ノイズキャリア生成**: ピンクノイズ (-18dBFS) を生成し、包絡線でアンプリチュードモジュレーション
    4. **ゲイン調整**: 振動強度を `envelope * 0.8` で制御 (MASTERDOCUMENT:284 準拠)
  - **出力**: モノラル振動信号 (20-150Hz, ノイズベース, 包絡追従)
- **参加者別ルーティング**:
  - participant1 の BeatEvent → CH3 (自己心拍の触覚提示)
  - participant2 の BeatEvent → CH4 (自己心拍の触覚提示)
  - Exchange/Mixed シーンでは相手心拍も混合 (設定可能な mix ratio)
- **レイテンシ管理**:
  - BeatEvent 生成から audioOut() までの遅延を 80ms 以内に維持
  - オーディオバッファサイズを 512 frames @ 48kHz で固定 (約 10.7ms/buffer)
- **既存コードとの統合**:
  - `HapticEventLogger` は引き続き CH3/4 の出力をモニタリングし CSV に記録
  - `appendHapticEvent()` (ofApp.cpp:467) は触覚信号のトリガータイミングをログ

**LED連動の削除**:
スピーカー型振動子には LED 機能がないため、MASTERDOCUMENT:304 の「LED 点灯」要求は**別デバイスとして将来対応** (Phase 3 以降に延期)。

**受入基準**:
- [ ] 4ch オーディオ出力が macOS Aggregate Device で動作
- [ ] CH3/4 に 20-150Hz の振動信号が出力される
- [ ] BeatEvent から触覚信号出力まで <80ms
- [ ] 振動強度が Envelope に追従する (目視+触感確認)
- [ ] 触覚信号が心拍リズムに同期している (録音データ解析)

**テスト計画**:
- オーディオインターフェース接続テスト: 4ch 出力をオシロスコープで確認
- 周波数応答テスト: CH3/4 の FFT で 20-150Hz 帯域を検証
- 同期テスト: BeatEvent timestamp と CH3/4 出力のタイムスタンプを比較
- 実機触感テスト: 振動子を身体に装着し、心拍リズムとの一致を体感確認

**工数見積**: 2-3日 (オーディオルーティング拡張 + HapticSignalGenerator 実装)

---

## III. 工数総計と優先順位マトリクス

| Phase | 内容 | 総工数 | 優先度 | 依存関係 | 推奨担当 |
|-------|------|--------|--------|----------|----------|
| **Phase 1** | **展示最低限機能** | **28-35日** | **P0** | - | 全員 (並行作業) |
| 1.1 | シーン構造完全実装 | 8-10日 | P0 | - | MemberB (UI), MemberA (audio routing) |
| 1.2 | GLSL シェーダ | 12-15日 | P0 | - | MemberB + 外部 shader エンジニア (option) |
| 1.3 | 日本語フォント | 1-2日 | P0 | - | MemberB |
| 1.4 | GUI 隠蔽 | 1日 | P0 | - | MemberC |
| 1.5 | Binaural オーディオ | 6-8日 | P0 | 1.1 (Exchange/Mixed 実装後) | MemberA |
| **Phase 2** | **安定性・品質** | **13-18日** | **P1** | Phase 1 完了 | 全員 |
| 2.0 | 単独検証モード | 1-2日 | P1 | - | MemberA |
| 2.1 | 長時間稼働安定性 | 4-5日 | P1 | - | MemberC + MemberA (audio) |
| 2.2 | 心拍検出精度 | 3-4日 | P1 | - | MemberA |
| 2.3 | 統合テスト自動化 | 3-4日 | P1 | - | MemberC |
| 2.4 | ハプティクス統合 | 2-3日 | P1 | Phase 1 完了 | MemberA |
| **Phase 3** | **UX・運用改善** | **2-3日** | **P2** | Phase 2 完了 | 分担 |
| 3.1 | 運用マニュアル | 2-3日 | P2 | - | MemberC (編集), 全員 (レビュー) |

**総工数**: 43-56日 (人日)
**3名並行作業時の実稼働日数**: 15-20営業日 (約3-4週間)

**工数調整の理由**:
- ハプティクスを USB/OSC デバイスではなくオーディオ CH3/4 に統合することで、Phase 3 から Phase 2 へ前倒し、かつ工数を 3-4日 → 2-3日 に短縮
- 単独検証モード (1-2日) を Phase 2 に追加し、開発効率を向上
- LED 連動を Phase 3 以降に延期

---

## IV. 即時対応アクションアイテム (今週中に着手)

### 緊急対応 (本日~3日以内)

1. **プロジェクトフェーズの明確化** (MemberC リード):
   - `PROJECT_PHASES.md` 作成
   - Phase 0: 小規模プロト (現在完了)
   - Phase 1: 展示最低限機能 (これから開始)
   - Phase 2: 品質向上
   - Phase 3: 運用最適化
   - 各フェーズの完了基準・成果物を定義
   - チーム全体で認識共有 (30分ミーティング)

2. **SceneState enum の拡張** (MemberB):
   - `SceneController.h` を編集し `Start/Exchange/Mixed` 追加
   - コンパイルエラーを修正 (switch 文の網羅性)
   - PR 作成・レビュー依頼

3. **日本語フォントの緊急対応** (MemberB):
   - Noto Sans JP をダウンロード・配置
   - `ofApp::setup()` でフォント読込追加
   - 最低限 Start シーンのテキスト表示を確認

4. **MASTERDOCUMENT 準拠チェックリスト作成** (全員):
   - `COMPLIANCE_CHECKLIST.md` 作成
   - MASTERDOCUMENT の各セクション (シーン・オーディオ・ビジュアル・ハプティクス) に対応する実装状況を記載
   - 未実装項目を可視化

### 週次対応 (今週末まで)

5. **統合テスト環境の最小構成** (MemberC):
   - `tests/integration/minimal_test.cpp` 作成
   - Idle → FirstPhase → End の 3 シーンサイクルを自動実行
   - ログ出力を検証 (session.csv に 3 シーンが記録される)

6. **BeatTimeline 安定性の緊急パッチ** (MemberA):
   - `noTriggerCounter_` の緩和速度を 1/3 に減速
   - 60秒録音データで動作確認
   - 「フェードアウト問題」が改善されるか検証

7. **Exchange シーンのモックアップ作成** (MemberB):
   - 仮のビジュアル (2つの円リング) を CPU 描画で実装
   - BeatEvent との連動を確認 (データフロー検証)
   - 後で GLSL 化する前提の placeholder

---

## V. リスク管理と緩和策

### 高リスク項目

| リスクID | リスク内容 | 発生確率 | 影響度 | 緩和策 | オーナー |
|----------|-----------|----------|--------|--------|----------|
| **RISK-01** | **GLSL shader 実装が想定より困難** | 中 (40%) | 高 | ① 外部 shader エンジニアの短期契約 ② CPU フォールバック実装 (品質劣化許容) ③ 星空のみ先行実装、トーラスは P1 降格 | MemberB + PM |
| **RISK-02** | **Binaural 処理の CPU 負荷過大** | 中 (30%) | 高 | ① libmysofa の最適化版 (NEON SIMD) 利用 ② HRIR の間引き (azimuth step 10°→15°) ③ GPU convolution 検討 (Metal API) | MemberA |
| **RISK-03** | **3-4週間で Phase 1 完了が困難** | 高 (60%) | 致命的 | ① スコープ削減 (Mixed シーンを P1.5 に延期) ② 作業時間延長 (残業・週末作業) ③ 追加リソース投入 (外部委託) | PM + 全員 |
| **RISK-04** | **実機ハプティクスデバイス未調達** | 中 (50%) | 中 | ① Phase 3 を optional 化 ② ログ出力のみで展示 (視聴覚のみの体験) ③ 代替デバイス検討 (市販 LED テープ等) | PM + MemberB |
| **RISK-05** | **展示環境の GPU が OpenGL 4.1 未対応** | 低 (10%) | 高 | ① 事前に展示環境の Mac の GPU スペック確認 ② Metal API への移行検討 (工数増大) ③ OpenGL 3.3 互換モード実装 | MemberC + MemberB |

---

## VI. 成功基準とマイルストーン

### Phase 1 完了基準 (展示可能レベル)

- [ ] 6 シーン (Idle/Start/FirstPhase/Exchange/Mixed/End) が全て実装され、自動遷移が動作する
- [ ] GLSL shader によるビジュアルが動作し、60fps を維持する
- [ ] 日本語案内テキストが正しく表示される
- [ ] 心拍データがビジュアル・オーディオ・ハプティクス (ログ出力) に反映される
- [ ] Binaural オーディオで左右定位が明確に聞こえる
- [ ] 展示用 GUI 非表示モードが動作する
- [ ] 10 分間の連続稼働でクラッシュしない

### Phase 2 完了基準 (本番展示レベル)

- [ ] 30 分間連続稼働が安定 (クラッシュ・メモリリーク・性能劣化なし)
- [ ] 心拍検出精度が BPM 誤差 ±3 以内
- [ ] 統合テストが CI で自動実行され、全 pass
- [ ] デバイス接続断からの自動復旧が動作する
- [ ] ログローテーションが機能し、ディスク容量問題が発生しない

### Phase 3 完了基準 (常設展示レベル)

- [ ] 展示スタッフが運用マニュアルのみで操作可能
- [ ] 実機ハプティクスデバイスが BeatEvent に <40ms で反応
- [ ] トラブルシューティングガイドで 80% の問題を解決可能
- [ ] 1週間無人運用テストが成功

---

## VII. 結論と推奨事項

### 現状評価

プロジェクトは**技術的には健全**だが、**要件定義の二重構造**により展示必須機能の大部分が未実装。3名のエンジニアは各担当領域で高品質な実装を完了しているが、プロジェクト全体の統合・完成度管理が不在だった。

### 推奨事項

1. **即時にプロジェクトフェーズを再定義**し、チーム全体で「Phase 0 (プロト) 完了、Phase 1 (本開発) 開始」を共有する。
2. **Phase 1 の 3-4 週間を確保**し、展示最低限機能の実装に集中する。他の要求 (アクセシビリティ等) は Phase 3 以降に延期。
3. **週次レビューを強化**し、MASTERDOCUMENT 準拠チェックリストで進捗を可視化する。
4. **外部リソースの投入を検討**:
   - GLSL shader: 外部エンジニアの短期契約 (2週間) で 12-15日の工数を 7-8日に短縮
   - 統合テスト: QA エンジニアの支援で自動化を加速
5. **スコープ調整の準備**:
   - Mixed シーンは Exchange シーンが完成次第、展示初期バージョンでは省略も検討
   - ハプティクスは実機が間に合わない場合は「ログ出力のみ」で展示開始

### 最終コメント

このプロジェクトの核心価値は「心音を多感覚で外化し、他者との共鳴を促す体験」です。現状はその土台 (データパイプライン) が完成していますが、**体験の表現層 (ビジュアル・空間音響・触覚)** が欠落しています。

3-4週間の集中開発で Phase 1 を完遂すれば、展示可能なレベルに到達します。チームの技術力は高く、各メンバーの成果物の品質も良好です。今必要なのは**統合と完成への最後の一押し**です。

以上の課題分析と修正要件定義を、トップエンジニアへの指示書として提出します。

---

**作成者**: プロジェクト統括責任者
**レビュー必須**: PM, MemberA, MemberB, MemberC
**次回レビュー**: 2025-11-01 (3日後)
