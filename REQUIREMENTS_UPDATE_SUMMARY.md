# 要件定義更新サマリー (2025-10-29)

## 更新概要

プロジェクト統括責任者として、ハプティクスデバイスの実装方針と単独検証モードについて要件を明確化し、[CRITICAL_ISSUES_AND_FIXES.md](CRITICAL_ISSUES_AND_FIXES.md) を更新しました。

---

## 1. ハプティクスデバイス実装方針の明確化

### 誤認されていた仕様
- **旧仮定**: USB/OSC接続の振動モーター + LED デバイス
- **実装予定だった内容**: `HapticDeviceController` クラスで USB シリアル通信 or OSC (UDP) 経由で信号送出

### 実際の仕様
- **デバイス種別**: **スピーカー型振動子 (tactile transducer)**
- **接続方法**: 4ch オーディオインターフェース経由、macOS Aggregate Device で統合
- **チャンネル構成**:
  - **CH1**: 参加者1 ヘッドフォン左
  - **CH2**: 参加者2 ヘッドフォン右
  - **CH3**: 参加者1 触覚振動子 (スピーカー型)
  - **CH4**: 参加者2 触覚振動子 (スピーカー型)

### 技術的要求
- **周波数帯域**: 20-150Hz (振動子の有効帯域)
- **信号生成方法**:
  1. 心拍波形から 100Hz ローパスフィルタ済み包絡を取得
  2. 20-150Hz バンドパスフィルタ適用
  3. ピンクノイズ (-18dBFS) を生成し、包絡線でアンプリチュードモジュレーション
  4. 振動強度を `envelope * 0.8` で制御
- **レイテンシ目標**: BeatEvent 生成から audioOut() まで <80ms (旧目標 <40ms から緩和)
- **参加者別ルーティング**:
  - participant1 の BeatEvent → CH3 (自己心拍の触覚提示)
  - participant2 の BeatEvent → CH4 (自己心拍の触覚提示)
  - Exchange/Mixed シーンでは相手心拍も混合可能

### 実装内容
- `AudioPipeline::audioOut()` を 2ch → 4ch に拡張
- `HapticSignalGenerator` クラス新規実装
- `HapticEventLogger` は CH3/4 の出力をモニタリング

### LED連動について
- スピーカー型振動子には LED 機能がないため、MASTERDOCUMENT:304 の「LED 点灯」要求は**別デバイスとして将来対応** (Phase 3 以降に延期)

---

## 2. 単独検証モード (Solo Dev Mode) の追加

### 背景
現在の実装は2名の参加者(2ch マイク入力)を前提としており、Exchange/Mixed シーンの検証に2名の協力者が必要。開発・デバッグ効率を大幅に向上させるため、**疑似的な第2参加者**を生成する単独検証モードを追加。

### 実装内容

#### 合成心拍生成器 (`SyntheticHeartbeatGenerator` クラス)
- **目的**: リアルな心拍信号を生成し、実際のマイク入力の代替として使用
- **生成アルゴリズム**:
  1. **基準BPM**: 50-90 BPM の範囲でランダムに選択 (例: 68 BPM)
  2. **BPM変動**: ±5 BPM のゆらぎを 0.1Hz の sine 波で加える (呼吸性変動を模擬)
  3. **S1/S2 波形生成**:
     - S1: 30-80Hz の複合 sine 波、持続時間 80-120ms、ピーク振幅 0.6-0.8
     - S2: 60-120Hz の複合 sine 波、持続時間 60-90ms、ピーク振幅 0.4-0.6
     - S1-S2 間隔: 300-400ms (収縮期)
  4. **ノイズ付加**: ホワイトノイズを -40dBFS で重畳
  5. **不規則性**: 10% の確率で premature beat (早期拍動) を挿入
- **出力**: 48kHz/1ch のモノラル信号として `AudioPipeline` に注入

#### モード切替
- `app_config.json` に `"devMode": { "enabled": true, "soloMode": true }` を追加
- `soloMode=true` 時:
  - participant1: 実際のマイク入力 (CH1)
  - participant2: `SyntheticHeartbeatGenerator` の出力 (CH2 相当)
- GUI に "Solo Dev Mode" インジケーターを表示 (exhibition モードでは非表示)

#### パラメータ調整 (debug モード時のみ)
- `syntheticBPM`: 50-90 BPM (default: 68)
- `syntheticVariability`: 0-10 BPM (default: 5)
- `syntheticNoiseLevel`: -60 to -20 dBFS (default: -40)
- リアルタイムで合成信号を調整可能

#### 再現性の確保
- `session_seed.json` の seed 値を `SyntheticHeartbeatGenerator` の乱数生成器に設定
- 同じ seed で起動すれば、同じ合成心拍が再生される (デバッグ・リグレッションテスト用)

### 受入基準
- [ ] `soloMode=true` で起動時、participant2 の心拍が自動生成される
- [ ] 合成心拍の BPM が 50-90 の範囲でランダムに変動する
- [ ] Exchange/Mixed シーンで2名の心拍が視覚・聴覚・触覚で区別可能
- [ ] 合成心拍の波形が BeatTimeline で正しく検出される (誤検出率 <5%)
- [ ] session_seed による再現性が確保される

### 工数見積
**1-2日** (SyntheticHeartbeatGenerator 実装 + GUI 統合)

---

## 3. 工数・優先度の更新

### Phase 2 の拡張
- **2.0 単独検証モード**: 1-2日 (新規追加)
- **2.4 ハプティクス統合**: 2-3日 (Phase 3 から前倒し、USB/OSC → オーディオ統合により工数削減)

### 総工数の変化
- **旧**: 42-51日 (人日) → 実稼働 14-18営業日
- **新**: 43-56日 (人日) → 実稼働 15-20営業日

### 優先度の変化
- **HPT-01 (ハプティクス統合)**: P2 → **P1** (オーディオ出力の一部として必須)
- **HPT-02 (LED連動)**: P1 → **P2 (スコープ外)** (Phase 3 以降に延期)
- **FIX-DEV-SOLO (単独検証モード)**: **P1 (新規)** (開発効率向上のため必須)

---

## 4. 課題表の更新内容

### 修正された課題

| 課題ID | 変更内容 | 理由 |
|--------|----------|------|
| HPT-01 | 「実機ハプティクスデバイスとの統合未完了」→「ハプティクス信号生成の未実装」 | デバイス種別をスピーカー型振動子に明確化、USB/OSC → オーディオCH3/4 |
| HPT-02 | 「ExchangeシーンのLED連動仕様未実装」→「スコープ外 (Phase 3以降)」 | スピーカー型振動子にはLED機能がないため延期 |
| HPT-03 | レイテンシ目標 <40ms → <80ms | オーディオバッファ遅延(10.7ms)を考慮した現実的な目標に修正 |

### 新規追加された要件

| 要件ID | 内容 | Phase | 優先度 | 工数 |
|--------|------|-------|--------|------|
| FIX-DEV-SOLO | 単独検証モードの実装 | Phase 2 | P1 | 1-2日 |
| FIX-HPT-DEVICE | ハプティクス統合 (オーディオCH3/4) | Phase 2 | P1 | 2-3日 |

---

## 5. 次のステップ

### 即時対応 (今週中)
1. **ハプティクス実装方針の共有** (MemberA リード):
   - チーム全体に4chオーディオ構成を説明 (15分ミーティング)
   - macOS Aggregate Device 設定手順を文書化
   - 4ch オーディオインターフェースの動作確認

2. **単独検証モードの設計** (MemberA):
   - `SyntheticHeartbeatGenerator` クラスの詳細設計
   - S1/S2 波形生成アルゴリズムの検証 (prototype スクリプト作成)
   - `app_config.json` に `devMode.soloMode` パラメータ追加

3. **Phase 2 タスクの再割当** (全員):
   - 2.0 単独検証モード (MemberA: 1-2日)
   - 2.4 ハプティクス統合 (MemberA: 2-3日)
   - 並行作業可能な他タスクとのスケジュール調整

### 中期対応 (来週~)
4. **ハプティクス統合の実装** (MemberA):
   - `AudioPipeline::audioOut()` の 4ch 拡張
   - `HapticSignalGenerator` 実装 (20-150Hz BPF, ノイズキャリア生成)
   - レイテンシ測定・最適化

5. **単独検証モードのテスト** (MemberA + MemberC):
   - 合成心拍の波形検証 (FFT, BPM 精度)
   - Exchange/Mixed シーンでの動作確認
   - 再現性テスト (同一 seed での BPM 系列一致)

---

## 6. ステークホルダーへの確認事項

### 技術的確認
- [ ] 4ch オーディオインターフェースの機種・仕様を確認 (CH3/4 の出力インピーダンス、最大出力レベル)
- [ ] スピーカー型振動子の仕様書確認 (有効周波数帯域、推奨入力レベル、ケーブル接続方法)
- [ ] macOS Aggregate Device 設定の制約・注意点 (サンプルレート同期、バッファサイズ)

### 運用確認
- [ ] 展示環境で4chオーディオ出力が利用可能か (Mac の USB ポート数、ケーブル配線)
- [ ] 単独検証モードを本番展示で無効化する手順の明確化 (config ファイルの差し替え or GUI ロック)

### スコープ確認
- [ ] LED 連動機能の Phase 3 延期について了承を得る
- [ ] 単独検証モードが開発専用機能であることの確認 (展示参加者には露出しない)

---

## 7. リスクと緩和策

| リスク | 発生確率 | 影響度 | 緩和策 |
|--------|----------|--------|--------|
| 4ch オーディオ出力の遅延が想定より大きい (>100ms) | 低 (20%) | 中 | バッファサイズを 512 → 256 frames に縮小、レイテンシ再測定 |
| 合成心拍の波形が BeatTimeline で正しく検出されない | 中 (30%) | 中 | S1/S2 波形のピーク振幅を調整、実データとの比較検証を追加 |
| macOS Aggregate Device 設定が不安定 | 低 (15%) | 高 | デバイス設定を JSON で保存し、起動時に自動構成する仕組みを追加 |
| ハプティクス統合により Phase 2 の工数超過 | 中 (40%) | 中 | 単独検証モードを先行実装し、Exchange/Mixed シーンの検証を並行化 |

---

## 8. 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2025-10-29 | プロジェクト統括責任者 | ハプティクスデバイス実装方針・単独検証モード追加、CRITICAL_ISSUES_AND_FIXES.md 更新 |

---

**作成者**: プロジェクト統括責任者
**レビュー必須**: MemberA, MemberB, MemberC
**関連ドキュメント**: [CRITICAL_ISSUES_AND_FIXES.md](CRITICAL_ISSUES_AND_FIXES.md), [MASTERDOCUMENT.md](MASTERDOCUMENT.md)
